## Spring Cloud Gateway
**API Gateway** — это компонент, через который проходят все внешние запросы в микросервисной архитектуре.  
Он выполняет роль входной двери в систему и решает задачи маршрутизации, безопасности, фильтрации и трекинга запросов.

Другими словами, Gateway служит единой точкой входа в распределенную систему, 
перенаправляет запросы к нужным микросервисам,
выполняет сквозные задачи (логирование, авторизация и др.) и упрощает клиентам взаимодействие с системой, 
скрывая ее внутреннюю структуру. На практике Gateway помогает сделать архитектуру более устойчивой,
управляемой и безопасной.

## Проблема прямого взаимодействия клиента с микросервисами

В текущей архитектуре книжного магазина клиентское приложение (веб-интерфейс или мобильное приложение) вынуждено знать адреса и спецификации всех микросервисов:

http://book-service:8080/api/books - для работы с книгами

http://user-service:8081/api/users - для аутентификации и профилей

http://order-service:8082/api/orders - для заказов

http://notification-service:8083/api/notifications - для уведомлений

### Это создаёт несколько проблем: 
Во-первых, клиенту приходится управлять множеством подключений, что усложняет его логику. 
Во-вторых, отсутствует централизованная аутентификация — каждый сервис проверяет токены самостоятельно, что ведёт к дублированию кода и потенциальным уязвимостям. 
В-третьих, возникают сложности с масштабированием: при добавлении новых сервисов приходится обновлять всех клиентов.
Решением может стать создание единой точки входа для клиентского приложения.

Например, клиент делает запрос GET https://api.booklibrary.com/api/books,  
Gateway перенаправляет на http://book-service:8080/api/books. 

Аналогично для остальных сервисов:  
Клиент: POST https://api.booklibrary.com/api/orders  
Gateway -> http://order-service:8080/api/orders

При регистрации пользователя:  
Клиент: POST https://api.booklibrary.com/api/users/register  
Gateway -> http://user-service:8080/api/users/register

## Централизованная аутентификация через Gateway

В текущей архитектуре каждый микросервис самостоятельно занимается проверкой JWT-токенов, 
что приводит к дублированию кода и сложностям при обновлении механизмов безопасности. 
API Gateway решает эту проблему, забирая на себя ответственность за аутентификацию на уровне единой точки входа.

Принцип работы основан на цепочке фильтров Spring Cloud Gateway. Каждый входящий запрос проходит через 
GlobalFilter, который анализирует заголовок Authorization на наличие валидного JWT-токена. 
Публичные эндпоинты, такие, как просмотр каталога книг или регистрация новых пользователей, могут быть настроены для пропуска без проверки токена. 
Для защищённых операций — например, создания заказа или доступа к персональным данным — наличие корректного токена обязательно.

Процесс начинается с того, что пользователь проходит аутентификацию через UserService и получает JWT-токен, 
подписанный секретным ключом. При последующих запросах этот токен передаётся в заголовке Authorization. Gateway 
проверяет его подпись, срок действия и наличие необходимых прав. Если проверка успешна, Gateway извлекает из 
токена информацию о пользователе (идентификатор, роли) и добавляет её в запрос в виде специальных заголовков, 
таких как X-User-Id и X-User-Roles.

Микросервисы, получая запрос, уже не занимаются проверкой токена — вместо этого они используют переданные 
в заголовках данные для применения бизнес-правил авторизации. Например, OrderService может проверить, что 
пользователь с ID из заголовка X-User-Id действительно создаёт заказ для своего аккаунта, или что его роль 
из заголовка X-User-Roles позволяет выполнять данную операцию.

## Преимущества внедрения

Внедрение Spring Cloud Gateway в архитектуру книжного магазина приносит несколько ключевых преимуществ. 
Во-первых, значительно упрощается клиентская часть — приложению достаточно знать только один адрес Gateway.
Во-вторых, централизация аутентификации повышает безопасность системы, устраняя расхождения в реализации
проверки токенов и позволяя единообразно применять политики безопасности. В-третьих, упрощается масштабирование 
и модификация системы: добавление новых сервисов или изменение механизмов аутентификации требует обновления 
только Gateway, а не всех компонентов системы.

Gateway также открывает возможности для реализации дополнительных функций: ограничения частоты запросов 
(rate limiting), предохранителей (circuit breakers) для защиты от сбоев в микросервисах, кэширования ответов 
и централизованного логирования. В перспективе Gateway может интегрироваться с системами service discovery
(такими как Eureka) для автоматического обнаружения микросервисов и балансировки нагрузки между их экземплярами.

Таким образом, Spring Cloud Gateway превращается не просто в маршрутизатор запросов, а в интеллектуальный 
управляющий компонент, который обеспечивает безопасность, наблюдаемость и устойчивость всей микросервисной 
архитектуры книжного магазина, позволяя бизнес-сервисам сосредоточиться исключительно на своей предметной области.
