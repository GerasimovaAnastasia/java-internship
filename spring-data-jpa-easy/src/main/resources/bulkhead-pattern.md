## Паттерн Bulkhead в архитектуре микросервисов

В распределенных системах, построенных по принципу микросервисной архитектуры, 
взаимодействие между сервисами представляет собой критически важный аспект 
обеспечения общей отказоустойчивости системы. Одним из ключевых паттернов проектирования устойчивых распределенных систем является 
паттерн Bulkhead, направленный на изоляцию ресурсов и предотвращение каскадных отказов.

Рассмотрим систему, состоящую из двух микросервисов: сервиса А, выполняющего основные бизнес-функции, 
и сервиса Б, предоставляющего вспомогательные возможности. Сервис А синхронно вызывает сервис Б
для выполнения определенных операций. В штатном режиме взаимодействие происходит корректно с 
минимальными задержками.

Проблема возникает при деградации производительности сервиса Б. Если время обработки запросов в
сервисе Б увеличивается с нескольких миллисекунд до десятков секунд, синхронная архитектура 
вызовов приводит к блокировке рабочих потоков в сервисе А. Каждый поток, выполняющий HTTP-запрос к сервису Б, 
переходит в состояние ожидания ответа, что приводит к постепенному исчерпанию пула потоков контейнера сервлетов.

При исчерпании пула потоков сервис А теряет способность обрабатывать входящие запросы, даже если
его внутренняя бизнес-логика функционирует корректно. Это явление известно как каскадный отказ 
(cascading failure), когда сбой или деградация одного компонента системы приводит к недоступности
других, изначально работоспособных компонентов.

Традиционные механизмы устойчивости, такие как Circuit Breaker и Retry, недостаточно эффективны 
в данной ситуации. Circuit Breaker срабатывает только при полной недоступности сервиса, а не при
деградации его производительности. Retry-механизмы могут усугубить проблему, создавая 
дополнительную нагрузку на уже замедлившийся сервис.

Паттерн Bulkhead получил свое название по аналогии с водонепроницаемыми переборками в 
судостроении, которые предотвращают затопление всего корабля при повреждении одного отсека. В 
программной архитектуре Bulkhead реализует изоляцию ресурсов путем ограничения количества 
одновременных вызовов к определенному сервису.

Реализация Bulkhead в Resilience4j предлагает два подхода:

### Semaphore Bulkhead: управление параллелизмом через счетчики  

Данный подход реализует контроль количества одновременных вызовов к защищаемому ресурсу через 
систему разрешений. Каждый вызов требует получения разрешения от семафора перед началом выполнения. 
Если доступное количество разрешений исчерпано, последующие вызовы либо блокируются до освобождения ресурса, 
либо немедленно отклоняются в зависимости от настроек таймаута ожидания.

Принцип работы Semaphore Bulkhead основан на изоляции на уровне прикладной логики, а не на уровне 
системных ресурсов. Этот подход не создает дополнительных потоков выполнения, а лишь регулирует доступ к 
существующим.

Semaphore Bulkhead особенно эффективен в сценариях, где важно ограничить нагрузку на зависимый сервис 
или ресурс, а также в условиях, когда создание дополнительных потоков выполнения нежелательно 
или невозможно. Этот подход отличается минимальными накладными расходами, поскольку не требует управления отдельным 
пулом потоков и связанными с ним ресурсами.

### ThreadPool Bulkhead: изоляция через выделенные ресурсы выполнения  

ThreadPool Bulkhead реализует изоляцию ресурсов путем создания и управления выделенным пулом 
потоков для выполнения операций, обращающихся к защищаемому сервису или ресурсу. Данный подход
обеспечивает физическое разделение ресурсов выполнения между различными компонентами системы. Выделенный пул потоков 
функционирует независимо от основного пула потоков приложения, что предотвращает влияние проблем в одном 
компоненте на доступность ресурсов выполнения в других компонентах.  

Архитектура ThreadPool Bulkhead включает три основных параметра управления: размер основного пула 
потоков, максимальный размер пула потоков и емкость очереди задач. Основной пул потоков 
определяет количество постоянно активных потоков, в то время как максимальный размер пула 
устанавливает верхнюю границу для создания дополнительных потоков при увеличении нагрузки. Очередь задач
служит буфером для запросов, которые не могут быть немедленно обработаны из-за занятости всех потоков.  

Принципиальное отличие ThreadPool Bulkhead от Semaphore подхода заключается в обеспечении изоляции на уровне
ресурсов выполнения. Когда зависимый сервис начинает демонстрировать деградацию производительности, задержки затрагивают 
только потоки в выделенном пуле, оставляя основной пул потоков приложения доступным для обработки других операций. Это предотвращает 
каскадное распространение проблем производительности по всей системе.

ThreadPool Bulkhead особенно эффективен в сценариях, где операции требуют значительного времени
выполнения или где необходимо обеспечить гарантированную доступность ресурсов выполнения для критически важных функций системы. 

Выбор между подходами зависит от конкретных требований системы, характеристик нагрузки и 
архитектурных ограничений. Semaphore Bulkhead предпочтителен в случаях, когда необходимо простое
и эффективное ограничение параллелизма с минимальными накладными расходами. ThreadPool Bulkhead
является более подходящим выбором в ситуациях, требующих строгой изоляции ресурсов выполнения и 
устойчивости к длительным операциям, которые могут блокировать потоки на значительные промежутки времени.