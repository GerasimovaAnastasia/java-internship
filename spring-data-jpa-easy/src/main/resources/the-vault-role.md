# Шифрование секретов (Vault)

В современной микросервисной архитектуре безопасное хранение конфиденциальных данных, таких как 
пароли к базам данных, API-ключи и токены доступа, представляет собой важную задачу. 
Традиционный подход размещения секретов в Git-репозиториях в открытом виде создает серьезные уязвимости
безопасности. Каждый коммит с паролями становится записью в истории, доступной всем, кто 
имеет доступ к репозиторию, что противоречит принципам безопасности.

ХashiCorp Vault предлагает решение этой проблемы, предоставляя централизованное 
управление секретами с шифрованием, контролем доступа и возможностями аудита. Vault работает по 
принципу безопасности с нулевым доверием, где секреты никогда не хранятся в открытом виде, а доступ 
строго контролируется через политики. В контексте инфраструктуры Spring Cloud Vault легко 
интегрируется с Config Server, создавая безопасный конвейер доставки конфигураций, где 
конфиденциальные данные остаются защищенными на протяжении всего жизненного цикла.

Процесс миграции секретов из Git в Vault включает несколько логических шагов. В существующем Git-репозитории Config Server 
мы находим файл book-service-prod.properties и удаляем строку spring.datasource.password=secret123, оставляя только spring.datasource.username=postgres.
Затем мы развертываем экземпляр Vault, который в среде разработки может работать как контейнер 
вместе с другими сервисами. Внутри Vault мы создаем выделенные пути для секретов каждого сервиса и окружения, например 
"secret/book-service/prod" для логина/пароля базы данных. Эти секреты шифруются при хранении и 
доступны только через надлежащие механизмы аутентификации, такие как токены, AppRole или учетные
записи службы Kubernetes. В Config Server добавляем конфигурацию для работы с Vault в application.yml, указывая 
адрес, токен и путь к секретам. Перезапускаем сервисы: Config Server теперь будет комбинировать публичные настройки 
из Git с секретами из Vault.

Spring Cloud Config Server выступает в качестве моста между приложениями и Vault. Вместо того
чтобы получать конфигурации напрямую из Git, Config Server настраивается для использования Vault в
качестве дополнительного бэкенда. Когда сервис, такой как Book-Service, запрашивает свою конфигурацию
с профилем "prod", Config Server объединяет свойства из нескольких источников: общие настройки из Git,
конфигурации для конкретной среды и конфиденциальные секреты из Vault. Этот гибридный подход сохраняет
удобство Git для нечувствительных конфигураций, одновременно используя безопасность Vault для учетных
данных.

Сначала происходит сохранение учетных данных PostgreSQL в Vault, используя его хранилище "ключ-значение". 
Затем конфигурация Config Server обновляется для указания на экземпляр Vault с указанием деталей 
аутентификации и путей к секретам. В репозитории Git мы удаляем пароли в открытом виде из файлов 
свойств, заменяя их заполнителями или полностью опуская конфиденциальные поля. Во время выполнения, 
когда Book-Service запускается с производственным профилем, Config Server извлекает полную конфигурацию, прозрачно для приложения 
объединяя публичные свойства из Git с приватными секретами из Vault.

Эта архитектура предлагает множество преимуществ безопасности помимо простого шифрования. Vault
позволяет генерировать динамические секреты, где учетные данные базы данных могут создаваться по 
запросу с ограниченным сроком действия, снижая риск утечки учетных данных. Аудит доступа 
обеспечивает полную видимость того, кто, когда и к каким секретам обращался. Ротация секретов может 
быть автоматизирована без очередного развертывания приложения. Более того, разные среды могут иметь 
изолированные экземпляры или пространства имен Vault, обеспечивая разделение производственных и 
учетных данных разработки.

В заключение, перенос паролей баз данных из Git в HashiCorp Vault представляет собой прогресс в 
обеспечении безопасности приложений. Этот подход соответствует лучшим практикам безопасности, 
сохраняя при этом гибкость и удобство для разработчиков в экосистеме Spring Cloud. Централизуя 
управление секретами в Vault и используя Config Server в качестве уровня распространения, организации
достигают надежного контроля безопасности без ущерба для операционной эффективности, создавая основу 
для безопасного масштабного развертывания микросервисов.



